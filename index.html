<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket –ß–∞—Ç —Å JWT</title>
    <link rel="stylesheet" href="css/style.css">
<!--    <style>-->
<!--        body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; }-->
<!--        input, button { margin: 5px 0; padding: 10px; width: 100%; }-->
<!--        #chatList div { padding: 10px; border: 1px solid #ccc; margin: 5px 0; cursor: pointer; }-->
<!--        #chat { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; }-->
<!--    </style>-->
</head>
<body>
    <form method="post" class="sign_form">
        <h1 class="sign_form_title">–í–æ–π—Ç–∏</h1>
        <input type="text" id="username_sign" class="sign_form_username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
        <input type="password" id="password_sign" class="sign_form_password" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="sign_form_button">–í–æ–π—Ç–∏</button>
        <span class="sign_form_link">–∏–ª–∏ <span class="sign_form_link_inner">–∑–∞—Ä–µ–≥–µ—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</span></span>
    </form>
    <form method="post" class="registration_form">
        <h1 class="sign_form_title_reg">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
        <input type="text" id="username" class="sign_form_username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
        <input type="text" id="mail" class="sign_form_username" placeholder="–ü–æ—á—Ç–∞">
        <input type="password" id="password" class="sign_form_password" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="login()" class="reg_form_button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <span class="sign_form_link">–∏–ª–∏ <span class="reg_form_link_inner">–≤–æ–π—Ç–∏</span></span>
    </form>
    <div class="main_chats_body">
        <div class="chats_body_container">
            <div class="chats_tools">
                <img class="chats_settings" src="images/menu_24dp_E3E3E3_FILL0_wght400_GRAD0_opsz24.svg" alt="settings">
                <input class="chats_search" type="search" placeholder="–ü–æ–∏—Å–∫">
            </div>
            <div class="chats_box">

            </div>
        </div>
        <div class="chat_screen">

        </div>
    </div>
<!--    <h2>–í–∞—à–∏ —á–∞—Ç—ã</h2>-->
<!--    <div id="chatList"></div>-->

<!--    <h2 id="chatTitle">–ß–∞—Ç</h2>-->
<!--    <div id="chat"></div>-->

<!--    <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">-->
<!--    <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>-->
    <script type="module" src="style.js"></script>
    <script type="module" src="script.js"></script>
<!--    <script>-->
<!--document.addEventListener("DOMContentLoaded", () => {-->
<!--    refreshAccessToken()-->
<!--        .then(() => {-->
<!--            loadChats();-->
<!--            connectWebSocket();-->
<!--        })-->
<!--        .catch(() => console.log("Not authorized!"));-->
<!--});-->

<!--function login() {-->
<!--    const username = document.getElementById('username').value;-->
<!--    const password = document.getElementById('password').value;-->

<!--    fetch("http://localhost:8080/login", {-->
<!--        method: "POST",-->
<!--        headers: { "Content-Type": "application/json" },-->
<!--        body: JSON.stringify({ username, password })-->
<!--    })-->
<!--    .then(res => res.json())-->
<!--    .then(data => {-->
<!--        if (data.accessToken) {-->
<!--            localStorage.setItem("accessToken", data.accessToken);-->
<!--            localStorage.setItem("refreshToken", data.refreshToken);-->
<!--            localStorage.setItem("username", username);-->
<!--            connectWebSocket();-->
<!--            loadChats();-->
<!--        } else {-->
<!--            console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏");-->
<!--        }-->
<!--    })-->
<!--    .catch(err => console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", err));-->
<!--}-->

<!--function connectWebSocket() {-->
<!--    const token = localStorage.getItem('accessToken');-->
<!--    if (!token) return console.error("–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞");-->

<!--    ws = new WebSocket(`ws://localhost:8080/ws?token=${encodeURIComponent(token)}`);-->

<!--    ws.onopen = () => console.log("‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á—ë–Ω");-->
<!--    ws.onerror = (err) => console.error("‚ùå WebSocket –æ—à–∏–±–∫–∞:", err);-->
<!--    ws.onclose = () => console.log("üî¥ WebSocket –æ—Ç–∫–ª—é—á—ë–Ω");-->
<!--    ws.onmessage = (event) => {-->
<!--        const data = JSON.parse(event.data);-->
<!--        if (data.action === "send_message") {-->
<!--            receiveMessage(event.data);-->
<!--        }else if (data.action === "delete_message"){-->
<!--            removeMessage(data.message_id)-->
<!--        }-->
<!--        else if (data.action === "edit_message"){-->
<!--            console.log(data)-->
<!--            changeMessage(data.message_id, data.new_content)-->
<!--        }-->
<!--        else {-->
<!--            console.log("Invalid action type");-->
<!--        }-->
<!--    };-->
<!--&lt;!&ndash;}&ndash;&gt;-->

<!--function sendMessage() {-->
<!--    const messageInput = document.getElementById("messageInput");-->
<!--    const message = messageInput.value.trim();-->
<!--    if (!message || !ws) return;-->

<!--    const username = localStorage.getItem("username");-->
<!--    const recipient = localStorage.getItem("to");-->
<!--    if (!recipient) return console.error("–ù–µ –≤—ã–±—Ä–∞–Ω —á–∞—Ç!");-->

<!--    const msgObj = { action: "send_message", from: username, to: recipient, content: message };-->
<!--    ws.send(JSON.stringify(msgObj));-->
<!--    messageInput.value = "";-->
<!--}-->

<!--function loadChats() {-->
<!--    const token = localStorage.getItem("accessToken");-->
<!--    if (!token) {-->
<!--        console.error("‚ùå –û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.");-->
<!--        return;-->
<!--    }-->

<!--    fetch("http://localhost:8080/get-chats", {-->
<!--        method: "GET",-->
<!--        headers: { "Authorization": `Bearer ${token}` }-->
<!--    })-->
<!--    .then(res => {-->
<!--        if (res.status === 401) {-->
<!--            console.warn("‚ö†Ô∏è –¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫, –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å...");-->
<!--            return refreshAccessToken().then(loadChats);-->
<!--        }-->
<!--        if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${res.status}`);-->
<!--        return res.json();-->
<!--    })-->
<!--    .then(chats => {-->
<!--        if (!Array.isArray(chats)) throw new Error("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º!");-->

<!--        const chatList = document.getElementById("chatList");-->
<!--        chatList.innerHTML = "";-->
<!--        chats.forEach(chat => {-->
<!--            chatList.innerHTML += `<div onclick="openChat('${chat.username}')">-->
<!--                <strong>${chat.username}</strong>: ${chat.last_message || "–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π"} <br>-->
<!--                <small>${chat.timestamp ? new Date(chat.timestamp).toLocaleString() : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –≤—Ä–µ–º—è"}</small>-->
<!--            </div>`;-->
<!--        });-->
<!--    })-->
<!--    .catch(err => console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:", err));-->
<!--}-->

<!--function refreshAccessToken() {-->
<!--    const refreshToken = localStorage.getItem("refreshToken");-->
<!--    if (!refreshToken) {-->
<!--        console.error("‚ùå –û—à–∏–±–∫–∞: Refresh-—Ç–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!");-->
<!--        return Promise.reject("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç refreshToken");-->
<!--    }-->

<!--    return fetch("http://localhost:8080/refresh", {-->
<!--        method: "POST",-->
<!--        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${refreshToken}` },-->
<!--    })-->
<!--    .then(res => {-->
<!--        if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: ${res.status}`);-->
<!--        return res.json();-->
<!--    })-->
<!--    .then(data => {-->
<!--        console.log("üîÑ –¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª—ë–Ω!");-->
<!--        localStorage.setItem("accessToken", data.accessToken);-->
<!--        localStorage.setItem("refreshToken", data.refreshToken);-->
<!--        return data.accessToken;-->
<!--    })-->
<!--    .catch(err => {-->
<!--        console.log("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:", err);-->
<!--        return Promise.reject(err);-->
<!--    });-->
<!--}-->

<!--function openChat(username) {-->
<!--    localStorage.setItem("to", username);-->
<!--    document.getElementById("chatTitle").innerText = "–ß–∞—Ç —Å " + username;-->
<!--    document.getElementById("chat").innerHTML = "";-->
<!--    loadMessages(username);-->
<!--}-->

<!--function loadMessages(username) {-->
<!--    fetch(`http://localhost:8080/get-messages?user=${username}`, {-->
<!--        method: "GET",-->
<!--        headers: { "Authorization": "Bearer " + localStorage.getItem("accessToken") }-->
<!--    })-->
<!--    .then(res => res.json())-->
<!--    .then(messages => {-->
<!--        if (!Array.isArray(messages)) return;-->

<!--        const chatBox = document.getElementById("chat");-->
<!--        chatBox.innerHTML = "";-->
<!--        messages.forEach(msg => {-->
<!--            chatBox.innerHTML += `<div class="message-${msg.id}">-->
<!--                <div><strong>${msg.from}:</strong> <span id="msg-content-${msg.id}">${msg.content}</span></div>-->
<!--                <div>-->
<!--                    <button onclick="editMessage(${msg.id})">Edit</button>-->
<!--                    <button onclick="deleteMessage(${msg.id})">Delete</button>-->
<!--                </div>-->
<!--            </div>`;-->
<!--        });-->
<!--        chatBox.scrollTop = chatBox.scrollHeight;-->
<!--    })-->
<!--    .catch(err => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:", err));-->
<!--}-->

<!--function deleteMessage(id) {-->
<!--    const message = { action: "delete_message", message_id: id };-->
<!--    ws.send(JSON.stringify(message));-->
<!--}-->

<!--function removeMessage(id){-->
<!--    let box = document.getElementsByClassName(`message-${id}`)-->
<!--    box[0].remove()-->
<!--}-->

<!--function changeMessage(id, content){-->
<!--    let box = document.querySelector(`#msg-content-${id}`)-->
<!--    box.textContent = content-->
<!--}-->

<!--function editMessage(id) {-->
<!--    const msgSpan = document.getElementById(`msg-content-${id}`);-->
<!--    const newContent = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç:", msgSpan.innerText);-->
<!--    if (!newContent) return;-->

<!--    const message = { action: "edit_message", message_id: id, new_content: newContent };-->
<!--    ws.send(JSON.stringify(message));-->
<!--}-->
<!--function receiveMessage(data) {-->
<!--    const chatBox = document.getElementById("chat");-->
<!--    const msg = JSON.parse(data);-->
<!--    console.log(msg)-->
<!--    chatBox.innerHTML += `<div class="message-${msg.message_id}">-->
<!--<div><strong>${msg.from}:</strong> <span id="msg-content-${msg.message_id}">${msg.content}</span></div>-->
<!--<div>-->
<!--    <button onclick="editMessage(${msg.message_id})">Edit</button>-->
<!--    <button onclick="deleteMessage(${msg.message_id})">Delete</button>-->
<!--</div>-->
<!--</div>`;-->
<!--    chatBox.scrollTop = chatBox.scrollHeight;-->
<!--}-->

<!--</script>-->

</body>
</html>
